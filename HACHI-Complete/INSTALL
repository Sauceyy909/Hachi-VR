#!/bin/bash
# HACHI VR Complete System - Universal Installer
# Supports: Arch Linux, Ubuntu, Debian, Manjaro, and derivatives

set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

INSTALL_SUCCESS=false

cleanup_message() {
    if [ "$INSTALL_SUCCESS" != "true" ]; then
        echo ""
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED} Installation did not finish cleanly.${NC}"
        echo -e "${YELLOW} Please review the errors above, resolve them, and run ./INSTALL again.${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    fi
}

trap cleanup_message EXIT

write_driver_status() {
    local status="$1"
    local driver_path="$2"
    local repair_attempted="$3"
    local repair_result="$4"
    local repair_message="$5"

    local path_json="null"
    if [ -n "$driver_path" ]; then
        path_json="\"$driver_path\""
    fi

    mkdir -p "$HACHI_DIR"
    cat > "$HACHI_DIR/driver_status.json" <<STATUS_EOF
{
  "status": "${status}",
  "path": ${path_json},
  "checked_at": "$(date --iso-8601=seconds)",
  "repair_attempted": "${repair_attempted}",
  "repair_result": "${repair_result}",
  "repair_message": "${repair_message}"
}
STATUS_EOF
}

select_steamvr_target() {
    local target=""
    for candidate in "${STEAMVR_SEARCH_PATHS[@]}"; do
        local parent_dir
        parent_dir="$(dirname "${candidate}")"
        if [ -d "$parent_dir" ]; then
            target="$candidate"
            break
        fi
    done

    if [ -z "$target" ]; then
        target="${STEAMVR_SEARCH_PATHS[0]}"
    fi

    echo "$target"
}

attempt_steamvr_repair() {
    local target_dir="$1"

    if ! command -v steamcmd &> /dev/null; then
        echo -e "${YELLOW}  ! steamcmd is not installed; skipping automatic SteamVR repair${NC}"
        echo -e "${YELLOW}    Install steamcmd (package: steamcmd) and re-run ./INSTALL to retry.${NC}"
        return 2
    fi

    mkdir -p "$target_dir"
    echo -e "${CYAN}  â€¢ Validating SteamVR files via steamcmd...${NC}"
    if steamcmd +login anonymous +force_install_dir "$target_dir" +app_update 250820 validate +quit; then
        echo -e "${GREEN}  âœ“ SteamVR validation completed${NC}"
        return 0
    else
        echo -e "${YELLOW}  ! steamcmd validation did not complete successfully${NC}"
        return 1
    fi
}

locate_cosmos_driver() {
    for candidate in "${STEAMVR_SEARCH_PATHS[@]}"; do
        local driver_candidate="$candidate/drivers/vive_cosmos/bin/linux64/driver_cosmos.so"
        if [ -f "$driver_candidate" ]; then
            echo "$driver_candidate"
            return 0
        fi
    done

    return 1
}

clear

echo -e "${CYAN}"
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                              â•‘
â•‘     â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—                     â•‘
â•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘                     â•‘
â•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘                     â•‘
â•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘                     â•‘
â•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘                     â•‘
â•‘     â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•                     â•‘
â•‘                                                              â•‘
â•‘              VR COMPLETE SYSTEM FOR LINUX                    â•‘
â•‘         Universal Installer v2.0 (Arch + Debian)             â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}"

echo ""
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}  This installer will set up everything you need:${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "  ${CYAN}âœ“${NC} SteamVR Vive Cosmos driver health check"
echo -e "  ${CYAN}âœ“${NC} Real Finger Tracking System (OpenCV)"
echo -e "  ${CYAN}âœ“${NC} HACHI Control Center GUI"
echo -e "  ${CYAN}âœ“${NC} All System Dependencies"
echo -e "  ${CYAN}âœ“${NC} USB Permissions & Configuration"
echo ""
echo -e "${YELLOW}Installation takes 10-15 minutes.${NC}"
echo -e "${YELLOW}You'll need to enter your password for sudo/doas access.${NC}"
echo ""
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
read -p "Press ENTER to start installation or Ctrl+C to cancel..."

# Check if running as root
if [ "$EUID" -eq 0 ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}ERROR: Do not run as root!${NC}"
    echo -e "${RED}Run as normal user: ./INSTALL${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    exit 1
fi

# Get script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

HOME_DIR="$HOME"
HACHI_DIR="$HOME_DIR/.local/share/hachi"
BIN_DIR="$HOME_DIR/.local/bin"
DESKTOP_DIR="$HOME_DIR/.local/share/applications"

STEAMVR_SEARCH_PATHS=(
    "$HOME_DIR/.local/share/Steam/steamapps/common/SteamVR"
    "$HOME_DIR/.steam/steamapps/common/SteamVR"
    "$HOME_DIR/.steam/steam/steamapps/common/SteamVR"
)

# Detect Linux distribution
echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}[1/12] Detecting Linux distribution...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

DISTRO="unknown"
PKG_MANAGER="unknown"
SUDO_CMD="sudo"

if [ -f /etc/os-release ]; then
    . /etc/os-release
    if [[ "$ID" == "arch" ]] || [[ "$ID_LIKE" == *"arch"* ]]; then
        DISTRO="arch"
        PKG_MANAGER="pacman"
        echo -e "${GREEN}  âœ“ Detected: Arch Linux${NC}"
    elif [[ "$ID" == "manjaro" ]]; then
        DISTRO="arch"
        PKG_MANAGER="pacman"
        echo -e "${GREEN}  âœ“ Detected: Manjaro Linux${NC}"
    elif [[ "$ID" == "ubuntu" ]] || [[ "$ID" == "debian" ]] || [[ "$ID_LIKE" == *"debian"* ]] || [[ "$ID_LIKE" == *"ubuntu"* ]]; then
        DISTRO="debian"
        PKG_MANAGER="apt"
        echo -e "${GREEN}  âœ“ Detected: $PRETTY_NAME${NC}"
    fi
fi

# Check for doas (common on some Arch setups)
if command -v doas &> /dev/null; then
    SUDO_CMD="doas"
    echo -e "${GREEN}  âœ“ Using doas for privilege escalation${NC}"
elif command -v sudo &> /dev/null; then
    SUDO_CMD="sudo"
    echo -e "${GREEN}  âœ“ Using sudo for privilege escalation${NC}"
else
    echo -e "${RED}  âœ— Neither sudo nor doas found!${NC}"
    exit 1
fi

if [ "$DISTRO" == "unknown" ]; then
    echo -e "${RED}  âœ— Unsupported distribution!${NC}"
    echo -e "${RED}  This installer supports Arch, Manjaro, Ubuntu, and Debian.${NC}"
    exit 1
fi

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}[2/12] Checking required commands...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

MISSING=0
REQUIRED_CMDS="lsusb python3"
for cmd in $REQUIRED_CMDS; do
    if ! command -v $cmd &> /dev/null; then
        echo -e "${YELLOW}  ! $cmd not found (will be installed)${NC}"
    else
        echo -e "${GREEN}  âœ“ $cmd found${NC}"
    fi
done

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}[3/12] Updating package database...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${YELLOW}  You may need to enter your password${NC}"

if [ "$DISTRO" == "arch" ]; then
    $SUDO_CMD pacman -Sy --noconfirm && echo -e "${GREEN}  âœ“ Package database updated${NC}"
else
    $SUDO_CMD apt-get update -qq && echo -e "${GREEN}  âœ“ Package database updated${NC}"
fi

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}[4/12] Installing system packages...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${YELLOW}  This may take a few minutes...${NC}"

if [ "$DISTRO" == "arch" ]; then
    # Arch Linux packages
    $SUDO_CMD pacman -S --noconfirm --needed \
        python \
        python-pip \
        python-numpy \
        python-pillow \
        tk \
        opencv \
        python-opencv \
        libusb \
        hidapi \
        cmake \
        gcc \
        make \
        v4l-utils \
        usbutils \
        || echo -e "${YELLOW}  Some packages may already be installed${NC}"
    
    echo -e "${GREEN}  âœ“ System packages installed${NC}"
else
    # Debian/Ubuntu packages
    $SUDO_CMD apt-get install -y -qq \
        python3 \
        python3-pip \
        python3-tk \
        python3-pil.imagetk \
        python3-numpy \
        python3-opencv \
        libusb-1.0-0-dev \
        libhidapi-dev \
        libudev-dev \
        cmake \
        build-essential \
        libopencv-dev \
        v4l-utils \
        usbutils \
        || echo -e "${YELLOW}  Some packages may already be installed${NC}"
    
    echo -e "${GREEN}  âœ“ System packages installed${NC}"
fi

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}[5/12] Ensuring pip3 is available...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Make sure pip3 is available
if ! command -v pip3 &> /dev/null; then
    echo -e "${YELLOW}  pip3 not found, installing...${NC}"
    
    if [ "$DISTRO" == "arch" ]; then
        $SUDO_CMD pacman -S --noconfirm python-pip
    else
        $SUDO_CMD apt-get install -y python3-pip
    fi
    
    if command -v pip3 &> /dev/null; then
        echo -e "${GREEN}  âœ“ pip3 installed successfully${NC}"
    else
        echo -e "${RED}  âœ— Failed to install pip3${NC}"
        exit 1
    fi
else
    echo -e "${GREEN}  âœ“ pip3 is available${NC}"
fi

# Upgrade pip
python3 -m pip install --user --upgrade pip &> /dev/null || true

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}[6/12] Installing Python packages...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Install Python packages
python3 -m pip install --user --quiet \
    opencv-contrib-python \
    numpy \
    pyusb \
    hidapi \
    pillow \
    || echo -e "${YELLOW}  Some packages may already be installed${NC}"

echo -e "${GREEN}  âœ“ Python packages installed${NC}"

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}[7/12] Removing previous HACHI installation...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

if [ -d "$HACHI_DIR" ] || [ -f "$BIN_DIR/hachi" ]; then
    echo -e "${YELLOW}  ! Previous installation detected${NC}"
    rm -rf "$HACHI_DIR"
    rm -f "$BIN_DIR/hachi"
    rm -f "$DESKTOP_DIR/hachi-control.desktop"
    rm -f "$HOME_DIR/.local/share/applications/hachi.desktop"
    rm -f "$HOME_DIR/.config/autostart/hachi.desktop"

    LEGACY_ITEMS=(
        "/usr/local/share/hachi"
        "/opt/hachi"
        "/usr/local/lib/hachi"
        "/usr/local/bin/hachi"
        "/usr/share/applications/hachi-control.desktop"
        "/usr/share/applications/hachi.desktop"
    )

    for legacy_path in "${LEGACY_ITEMS[@]}"; do
        if [ -e "$legacy_path" ]; then
            if $SUDO_CMD rm -rf "$legacy_path" 2>/dev/null; then
                echo -e "${GREEN}  âœ“ Removed legacy path: ${legacy_path}${NC}"
            else
                echo -e "${YELLOW}  ! Could not remove legacy path: ${legacy_path}${NC}"
            fi
        fi
    done

    echo -e "${GREEN}  âœ“ Removed old files${NC}"
else
    echo -e "${GREEN}  âœ“ No existing installation found${NC}"
fi

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}[8/12] Creating directories...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

mkdir -p "$HACHI_DIR"
mkdir -p "$BIN_DIR"
mkdir -p "$DESKTOP_DIR"

echo -e "${GREEN}  âœ“ Created: $HACHI_DIR${NC}"
echo -e "${GREEN}  âœ“ Created: $BIN_DIR${NC}"

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}[9/12] Checking SteamVR Vive Cosmos driver...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

COSMOS_DRIVER_PATH=""
STEAMVR_ROOT=""
REPAIR_ATTEMPTED="no"
REPAIR_RESULT="not-needed"
REPAIR_MESSAGE="detected-on-disk"

if driver_path=$(locate_cosmos_driver); then
    COSMOS_DRIVER_PATH="$driver_path"
    STEAMVR_ROOT="$(dirname "$COSMOS_DRIVER_PATH")"
    STEAMVR_ROOT="$(dirname "$STEAMVR_ROOT")"
    STEAMVR_ROOT="$(dirname "$STEAMVR_ROOT")"
fi

if [ -n "$COSMOS_DRIVER_PATH" ]; then
    echo -e "${GREEN}  âœ“ Found SteamVR Vive Cosmos driver at:${NC}"
    echo -e "      $COSMOS_DRIVER_PATH"
    echo -e "${GREEN}  âœ“ Leaving official driver untouched${NC}"

    write_driver_status "found" "$COSMOS_DRIVER_PATH" "$REPAIR_ATTEMPTED" "$REPAIR_RESULT" "$REPAIR_MESSAGE"
else
    echo -e "${RED}  âœ— SteamVR's Vive Cosmos driver was not found${NC}"
    echo -e "${YELLOW}    â€¢ Launch SteamVR once to let it deploy device drivers${NC}"
    echo -e "${YELLOW}    â€¢ HACHI will try to repair the installation automatically${NC}"

    REPAIR_ATTEMPTED="yes"
    REPAIR_RESULT="skipped"
    REPAIR_MESSAGE="steamcmd-unavailable"

    REPAIR_TARGET="$(select_steamvr_target)"
    if [ -n "$REPAIR_TARGET" ]; then
        echo -e "${CYAN}  â€¢ Attempting to repair SteamVR at:${NC}"
        echo -e "      $REPAIR_TARGET"
        if attempt_steamvr_repair "$REPAIR_TARGET"; then
            REPAIR_RESULT="succeeded"
            REPAIR_MESSAGE="steamcmd-validated"
        else
            REPAIR_EXIT=$?
            if [ "$REPAIR_EXIT" -eq 2 ]; then
                REPAIR_RESULT="skipped"
                REPAIR_MESSAGE="steamcmd-not-installed"
            else
                REPAIR_RESULT="failed"
                REPAIR_MESSAGE="steamcmd-error"
            fi
        fi

        if driver_path=$(locate_cosmos_driver); then
            COSMOS_DRIVER_PATH="$driver_path"
            STEAMVR_ROOT="$(dirname "$COSMOS_DRIVER_PATH")"
            STEAMVR_ROOT="$(dirname "$STEAMVR_ROOT")"
            STEAMVR_ROOT="$(dirname "$STEAMVR_ROOT")"
        fi
    fi

    if [ -n "$COSMOS_DRIVER_PATH" ]; then
        echo -e "${GREEN}  âœ“ SteamVR driver available after repair:${NC}"
        echo -e "      $COSMOS_DRIVER_PATH"
        REPAIR_RESULT="${REPAIR_RESULT:-succeeded}"
        write_driver_status "found" "$COSMOS_DRIVER_PATH" "$REPAIR_ATTEMPTED" "$REPAIR_RESULT" "$REPAIR_MESSAGE"
    else
        echo -e "${YELLOW}  ! Vive Cosmos driver still missing${NC}"
        echo -e "${YELLOW}    â€¢ Launch Steam and run a SteamVR file validation${NC}"
        echo -e "${YELLOW}    â€¢ Or reinstall SteamVR from the store page${NC}"
        write_driver_status "missing" "" "$REPAIR_ATTEMPTED" "$REPAIR_RESULT" "$REPAIR_MESSAGE"
    fi
fi

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}[10/12] Installing finger tracking module...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

if [ -f "finger_tracking.py" ]; then
    cp finger_tracking.py "$HACHI_DIR/finger_tracking.py"
    chmod +x "$HACHI_DIR/finger_tracking.py"
    echo -e "${GREEN}  âœ“ Finger tracking module installed${NC}"
    echo -e "${GREEN}  âœ“ Real OpenCV-based hand detection${NC}"
    echo -e "${GREEN}  âœ“ Finger counting algorithm active${NC}"
else
    echo -e "${RED}  âœ— finger_tracking.py not found!${NC}"
    exit 1
fi

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}[11/12] Installing HACHI Control Center...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

if [ -f "hachi_control.py" ]; then
    cp hachi_control.py "$HACHI_DIR/hachi_control.py"
    chmod +x "$HACHI_DIR/hachi_control.py"

    cat > "$BIN_DIR/hachi" <<LAUNCHER_EOF
#!/usr/bin/env bash
set -e
APP_DIR="$HACHI_DIR"
export PYTHONPATH="\$APP_DIR:\$PYTHONPATH"
exec python3 "\$APP_DIR/hachi_control.py" "\$@"
LAUNCHER_EOF

    chmod +x "$BIN_DIR/hachi"

    echo -e "${GREEN}  âœ“ Control center installed${NC}"
    echo -e "${GREEN}  âœ“ GPU-adaptive themes enabled${NC}"
    echo -e "${GREEN}  âœ“ Real-time monitoring active${NC}"

    if $SUDO_CMD ln -sf "$BIN_DIR/hachi" /usr/local/bin/hachi 2>/dev/null; then
        echo -e "${GREEN}  âœ“ System-wide launcher linked at /usr/local/bin/hachi${NC}"
    else
        echo -e "${YELLOW}  ! Could not create /usr/local/bin/hachi (insufficient permissions?)${NC}"
    fi
else
    echo -e "${RED}  âœ— hachi_control.py not found!${NC}"
    exit 1
fi

# Add ~/.local/bin to PATH if not already there
if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
    echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.bashrc"
    echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.profile" 2>/dev/null || true
    echo -e "${GREEN}  âœ“ Added ~/.local/bin to PATH${NC}"
fi

# Create desktop entry
cat > "$DESKTOP_DIR/hachi-control.desktop" << DESKTOP_EOF
[Desktop Entry]
Name=HACHI Control Center
Comment=VR Headset Management and Finger Tracking
Exec=$BIN_DIR/hachi
Icon=video-display
Terminal=false
Type=Application
Categories=Game;System;
DESKTOP_EOF

chmod +x "$DESKTOP_DIR/hachi-control.desktop"
echo -e "${GREEN}  âœ“ Desktop shortcut created${NC}"

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}[12/12] Capturing driver diagnostics...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

if [ -n "$COSMOS_DRIVER_PATH" ]; then
    echo -e "${GREEN}  âœ“ Vive Cosmos driver ready at:${NC}"
    echo -e "      $COSMOS_DRIVER_PATH"
else
    echo -e "${YELLOW}  ! Vive Cosmos driver still missing${NC}"
    echo -e "${YELLOW}    Use SteamVR â–¸ Devices â–¸ Update firmware / reinstall support${NC}"
fi

# Preserve manifest/settings for reference within HACHI's data directory
if [ -f "driver.vrdrivermanifest" ]; then
    cp driver.vrdrivermanifest "$HACHI_DIR/driver.vrdrivermanifest"
fi

if [ -f "resources.vrsettings" ]; then
    cp resources.vrsettings "$HACHI_DIR/resources.vrsettings"
fi

# Setup USB permissions
echo -e "${YELLOW}  Setting up USB permissions...${NC}"

RULES_FILE="/tmp/60-hachi-vr.rules"
cat > "$RULES_FILE" << 'UDEV_EOF'
# HTC Vive Cosmos
SUBSYSTEM=="usb", ATTR{idVendor}=="0bb4", ATTR{idProduct}=="0abb", MODE="0666", GROUP="plugdev"
SUBSYSTEM=="usb", ATTR{idVendor}=="28de", MODE="0666", GROUP="plugdev"

# HID devices
KERNEL=="hidraw*", ATTRS{idVendor}=="0bb4", MODE="0666", GROUP="plugdev"
KERNEL=="hidraw*", ATTRS{idVendor}=="28de", MODE="0666", GROUP="plugdev"

# Video devices (for finger tracking)
KERNEL=="video[0-9]*", MODE="0666", GROUP="video"
UDEV_EOF

$SUDO_CMD cp "$RULES_FILE" /etc/udev/rules.d/60-hachi-vr.rules
$SUDO_CMD udevadm control --reload-rules
$SUDO_CMD udevadm trigger

echo -e "${GREEN}  âœ“ USB rules installed${NC}"

# Add user to required groups
$SUDO_CMD usermod -a -G plugdev $USER 2>/dev/null || $SUDO_CMD gpasswd -a $USER plugdev
$SUDO_CMD usermod -a -G video $USER 2>/dev/null || $SUDO_CMD gpasswd -a $USER video

echo -e "${GREEN}  âœ“ User added to plugdev group${NC}"
echo -e "${GREEN}  âœ“ User added to video group${NC}"

echo -e "${GREEN}  âœ“ Native SteamVR integration verified${NC}"
echo -e "${GREEN}  âœ“ Driver status recorded for Control Center${NC}"

finish_installation_summary() {
    INSTALL_SUCCESS=true

    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                                                              â•‘${NC}"
    echo -e "${GREEN}â•‘              ğŸ‰ INSTALLATION COMPLETE! ğŸ‰                    â•‘${NC}"
    echo -e "${GREEN}â•‘                                                              â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${YELLOW}â•‘  âš ï¸  IMPORTANT: A SYSTEM REBOOT IS REQUIRED! âš ï¸            â•‘${NC}"
    echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${CYAN}Rebooting ensures USB permissions and drivers reload correctly.${NC}"
    echo ""
    echo -e "${GREEN}What was installed:${NC}"
    echo -e "  ${CYAN}âœ“${NC} SteamVR Vive Cosmos driver verification"
    echo -e "  ${CYAN}âœ“${NC} Real Finger Tracking (OpenCV-based)"
    echo -e "  ${CYAN}âœ“${NC} HACHI Control Center GUI"
    echo -e "  ${CYAN}âœ“${NC} All Dependencies & Libraries"
    echo -e "  ${CYAN}âœ“${NC} USB Permissions"
    echo ""
    echo -e "${GREEN}After rebooting:${NC}"
    echo -e "  ${MAGENTA}1.${NC} Find ${YELLOW}'HACHI Control Center'${NC} in your applications menu"
    echo -e "  ${MAGENTA}2.${NC} Or run: ${YELLOW}hachi${NC}"
    echo -e "  ${MAGENTA}3.${NC} Connect your VR headset"
    echo -e "  ${MAGENTA}4.${NC} Launch SteamVR from HACHI"
    echo -e "  ${MAGENTA}5.${NC} Enable finger tracking in the Finger Tracking tab"
    echo ""
    echo -e "${CYAN}Features ready to use:${NC}"
    echo -e "  â€¢ Real-time hand detection with OpenCV"
    echo -e "  â€¢ Finger counting (0-5 per hand)"
    echo -e "  â€¢ SteamVR driver health checks"
    echo -e "  â€¢ GPU-adaptive themes"
    echo -e "  â€¢ SteamVR integration"
    echo -e "  â€¢ System monitoring"
    echo ""
    echo -e "${GREEN}Documentation:${NC}"
    echo -e "  â€¢ README.md - Complete guide"
    echo -e "  â€¢ QUICK-START.txt - Quick reference"
    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}         Thank you for using HACHI VR! ğŸš€${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    read -p "Press ENTER to continue..."

    echo ""
    read -r -p "Would you like to reboot now to finalize the installation? [y/N]: " REBOOT_CHOICE
    if [[ $REBOOT_CHOICE =~ ^[Yy]$ ]]; then
        echo -e "${CYAN}Requesting system reboot...${NC}"
        $SUDO_CMD reboot || echo -e "${YELLOW}  ! Reboot command failed. Please reboot manually.${NC}"
    else
        echo -e "${YELLOW}Please reboot your system manually to complete the installation.${NC}"
    fi

    echo ""
}

finish_installation_summary
